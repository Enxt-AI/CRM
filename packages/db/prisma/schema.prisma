generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String            @id @default(uuid())
  username            String            @unique
  passwordHash        String
  fullName            String
  role                Role              @default(EMPLOYEE)
  isActive            Boolean           @default(true)
  needsPasswordChange Boolean           @default(true)
  lastLoginAt         DateTime?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  activities          Activity[]        @relation("ActivityCreator")
  clients             Client[]          @relation("AccountManager")
  deletedDeals        Deal[]            @relation("DealDeleter")
  deals               Deal[]            @relation("DealOwner")
  createdFolders      Folder[]          @relation("FolderCreator")
  leads               Lead[]            @relation("LeadOwner")
  uploadedDocuments   ManagedDocument[] @relation("DocumentUploader")
  meetings            Meeting[]         @relation("MeetingOrganizer")
  notes               Note[]            @relation("NoteAuthor")
  tasks               Task[]            @relation("TaskAssignee")
  sharedDocuments     ManagedDocument[] @relation("SharedDocuments")
  sharedFolders       Folder[]          @relation("SharedFolders")

  @@index([username])
  @@index([isActive])
  @@index([role])
}

model Lead {
  id                String            @id @default(uuid())
  name              String
  companyName       String?
  email             String?
  mobile            String?
  source            LeadSource        @default(OTHER)
  sourceDetails     String?
  pipelineStage     LeadPipelineStage @default(NEW)
  status            LeadStatus        @default(NEW)
  score             Int               @default(0)
  priority          Priority          @default(MEDIUM)
  tags              String[]
  ownerId           String
  isConverted       Boolean           @default(false)
  convertedAt       DateTime?
  convertedClientId String?           @unique
  lastContactedAt   DateTime?
  nextFollowUpAt    DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  estimatedValue    Decimal?          @db.Decimal(12, 2)
  initialNotes      String?
  activities        Activity[]
  documents         Document[]
  client            Client?           @relation(fields: [convertedClientId], references: [id])
  owner             User              @relation("LeadOwner", fields: [ownerId], references: [id])
  meetings          Meeting[]
  notes             Note[]
  tasks             Task[]

  @@index([ownerId, pipelineStage])
  @@index([ownerId, status])
  @@index([ownerId, isConverted])
  @@index([email])
  @@index([status])
  @@index([source])
  @@index([priority])
  @@index([nextFollowUpAt])
  @@index([isConverted])
}

model Client {
  id               String         @id @default(uuid())
  companyName      String
  primaryContact   String
  email            String?
  mobile           String?
  industry         String?
  domain           String?
  companySize      String?
  gstNumber        String?
  address          String?
  website          String?
  googleSheetUrl   String?
  notionPageUrl    String?
  slackChannel     String?
  status           ClientStatus   @default(ACTIVE)
  lifetimeValue    Decimal        @default(0) @db.Decimal(12, 2)
  accountManagerId String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  estimatedValue   Decimal?       @db.Decimal(12, 2)
  leadConvertedAt  DateTime?
  activities       Activity[]
  accountManager   User           @relation("AccountManager", fields: [accountManagerId], references: [id])
  deals            Deal[]
  documents        Document[]
  externalLinks    ExternalLink[]
  originLead       Lead?
  meetings         Meeting[]
  notes            Note[]
  tasks            Task[]

  @@index([accountManagerId, status])
  @@index([status])
  @@index([industry])
}

model ExternalLink {
  id        String   @id @default(uuid())
  title     String
  url       String
  clientId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}

model Deal {
  id                String    @id @default(uuid())
  title             String
  description       String?
  value             Decimal   @db.Decimal(12, 2)
  budget            Decimal?  @db.Decimal(12, 2)
  currency          String    @default("INR")
  dealType          String?
  industry          String?
  stage             DealStage @default(QUALIFICATION)
  progress          Int       @default(0)
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?
  nextSteps         String?
  clientId          String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?
  deletedById       String?
  isDeleted         Boolean   @default(false)
  ownerId           String
  client            Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  deletedBy         User?     @relation("DealDeleter", fields: [deletedById], references: [id])
  owner             User      @relation("DealOwner", fields: [ownerId], references: [id])

  @@index([clientId, stage])
  @@index([stage])
  @@index([ownerId, stage])
  @@index([ownerId, isDeleted])
  @@index([isDeleted, deletedAt])
  @@index([expectedCloseDate])
}

model Activity {
  id           String       @id @default(uuid())
  type         ActivityType
  title        String
  description  String?
  isFollowUp   Boolean      @default(false)
  followUpDate DateTime?
  createdById  String
  leadId       String?
  clientId     String?
  occurredAt   DateTime     @default(now())
  createdAt    DateTime     @default(now())
  client       Client?      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdBy    User         @relation("ActivityCreator", fields: [createdById], references: [id])
  lead         Lead?        @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId, occurredAt])
  @@index([clientId, occurredAt])
  @@index([createdById])
  @@index([isFollowUp, followUpDate])
}

model Meeting {
  id           String        @id @default(uuid())
  title        String
  description  String?
  location     String?
  meetingUrl   String?
  startTime    DateTime
  endTime      DateTime
  status       MeetingStatus @default(SCHEDULED)
  organizerId  String
  leadId       String?
  clientId     String?
  reminderSent Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  client       Client?       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  lead         Lead?         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  organizer    User          @relation("MeetingOrganizer", fields: [organizerId], references: [id])

  @@index([organizerId, startTime])
  @@index([startTime, status])
}

model Task {
  id           String    @id @default(uuid())
  title        String
  description  String?
  priority     Priority  @default(MEDIUM)
  type         TaskType  @default(GENERAL)
  isCompleted  Boolean   @default(false)
  completedAt  DateTime?
  assignedToId String
  dueDate      DateTime
  leadId       String?
  clientId     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  assignedTo   User      @relation("TaskAssignee", fields: [assignedToId], references: [id])
  client       Client?   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  lead         Lead?     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([assignedToId, isCompleted])
  @@index([dueDate, isCompleted])
  @@index([assignedToId, dueDate, isCompleted])
}

model Document {
  id         String   @id @default(uuid())
  name       String
  url        String
  fileType   String
  fileSize   Int?
  isLink     Boolean  @default(false)
  category   String?
  leadId     String?
  clientId   String?
  uploadedAt DateTime @default(now())
  client     Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  lead       Lead?    @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([clientId])
}

model Note {
  id        String   @id @default(uuid())
  content   String
  isPinned  Boolean  @default(false)
  authorId  String
  leadId    String?
  clientId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User     @relation("NoteAuthor", fields: [authorId], references: [id])
  client    Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  lead      Lead?    @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId, createdAt])
  @@index([clientId, createdAt])
  @@index([isPinned])
}

model Folder {
  id               String            @id @default(uuid())
  name             String
  type             FolderType        @default(SHARED)
  parentId         String?
  createdById      String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  createdBy        User              @relation("FolderCreator", fields: [createdById], references: [id])
  parent           Folder?           @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children         Folder[]          @relation("FolderHierarchy")
  managedDocuments ManagedDocument[]
  sharedWithUsers  User[]            @relation("SharedFolders")

  @@index([parentId])
  @@index([type])
  @@index([createdById])
}

model ManagedDocument {
  id              String       @id @default(uuid())
  name            String
  s3Key           String       @unique
  fileType        String
  fileSize        Int
  type            DocumentType @default(SHARED)
  folderId        String?
  uploadedById    String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  folder          Folder?      @relation(fields: [folderId], references: [id], onDelete: Cascade)
  uploadedBy      User         @relation("DocumentUploader", fields: [uploadedById], references: [id])
  sharedWithUsers User[]       @relation("SharedDocuments")

  @@index([folderId])
  @@index([type])
  @@index([uploadedById])
  @@index([s3Key])
}

enum Role {
  ADMIN
  MANAGER
  EMPLOYEE
}

enum LeadSource {
  WEBSITE
  LINKEDIN
  REFERRAL
  COLD_CALL
  TRADE_SHOW
  PARTNER
  EMAIL_CAMPAIGN
  OTHER
}

enum LeadStatus {
  NEW
  ATTEMPTING_CONTACT
  CONTACTED
  QUALIFIED
  NURTURING
  DISQUALIFIED
  CONVERTED
}

enum LeadPipelineStage {
  NEW
  CONTACTED
  PROPOSAL
  NEGOTIATION
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  CHURNED
  PAUSED
}

enum DealStage {
  QUALIFICATION
  NEEDS_ANALYSIS
  VALUE_PROPOSITION
  PROPOSAL_PRICE_QUOTE
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

enum ActivityType {
  CALL
  EMAIL
  MEETING
  FOLLOW_UP
  NOTE
  STATUS_CHANGE
  DOCUMENT_UPLOAD
  TASK_COMPLETED
  DEAL_CREATED
  CONVERTED
}

enum MeetingStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum TaskType {
  GENERAL
  CALL
  EMAIL
  FOLLOW_UP
  PROPOSAL
  CONTRACT
}

enum FolderType {
  SHARED
  PERSONAL
}

enum DocumentType {
  SHARED
  PERSONAL
}
